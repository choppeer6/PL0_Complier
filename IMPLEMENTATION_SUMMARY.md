# PL/0 编译器 - 语义分析与四元式生成

## ✅ 项目完成总结

本项目实现了 PL/0 编译器的**语义分析**和**四元式中间代码生成**功能。

## 📋 已实现的功能

### 1. 符号表管理 (SymbolTable)

- ✅ 支持三种符号类型：常量、变量、过程
- ✅ 多层作用域管理（嵌套过程）
- ✅ 地址自动分配
- ✅ 符号查找（从内向外）
- ✅ 重复定义检查

**符号表结构：**
```
名字    类型    层次    值      地址
x       变量    0       -       0
max     常量    0       100     -
inc     过程    0       5       -
```

### 2. 语义检查 (SemanticError)

- ✅ 标识符声明检查（使用前必须声明）
- ✅ 类型检查（常量不能赋值、过程不能用于表达式）
- ✅ 作用域检查（内层可访问外层）
- ✅ 重复定义检查（同一层次不能重复定义）

### 3. 四元式生成 (Quadruple)

**四元式格式：** `(操作符, 参数1, 参数2, 结果)`

**支持的操作：**
- ✅ 算术运算：`+`, `-`, `*`, `/`, `NEG`
- ✅ 关系运算：`=`, `#`, `<`, `>`, `<=`, `>=`
- ✅ 逻辑运算：`ODD`
- ✅ 控制流：`JMP`, `JZ`
- ✅ 过程：`PROC`, `CALL`, `RET`
- ✅ 输入输出：`READ`, `WRITE`
- ✅ 赋值：`=`

### 4. 临时变量管理

- ✅ 自动生成临时变量（T0, T1, T2...）
- ✅ 用于存储中间计算结果
- ✅ 支持复杂表达式的分解

### 5. 标签管理

- ✅ 自动生成标签（L0, L1, L2...）
- ✅ 用于过程入口标记
- ✅ 支持跳转地址回填

## 📊 测试结果

所有 **11 个测试用例** 全部通过：

1. ✅ 简单算术运算 - 生成 6 条四元式
2. ✅ 常量定义 - 生成 4 条四元式
3. ✅ 条件语句 - 生成 6 条四元式（含 JZ 跳转）
4. ✅ 循环语句 - 生成 11 条四元式（含 JMP 和 JZ）
5. ✅ ODD 函数 - 生成 5 条四元式
6. ✅ 复杂表达式 - 生成 8 条四元式（a*b+c）
7. ✅ 嵌套复合语句 - 生成 7 条四元式
8. ✅ 过程调用 - 生成 9 条四元式（含 PROC、CALL、RET）
9. ✅ READ 语句 - 生成 5 条四元式
10. ✅ 关系运算符 - 生成 9 条四元式
11. ✅ 负数 - 生成 5 条四元式（含 NEG）

## 🎯 代码示例

### 示例 1: 简单赋值

**源代码：**
```pl0
var x, y;
begin
    x := 10;
    y := 20;
    write(x + y)
end.
```

**符号表：**
```
名字    类型    层次    值      地址
x       变量    0       -       0
y       变量    0       -       1
```

**四元式：**
```
0   =       10      -       x
1   =       20      -       y
2   +       x       y       T0
3   WRITE   T0      -       -
4   END     -       -       -
```

### 示例 2: 条件语句

**源代码：**
```pl0
var x, y;
begin
    x := 15;
    y := 10;
    if x > y then
        write(x)
end.
```

**四元式：**
```
0   =       15      -       x
1   =       10      -       y
2   >       x       y       T0      # 比较 x > y
3   JZ      T0      -       5       # 如果为假，跳转到 5
4   WRITE   x       -       -       # 输出 x
5   END     -       -       -
```

### 示例 3: 循环语句

**源代码：**
```pl0
var n, sum;
begin
    n := 5;
    sum := 0;
    while n > 0 do
    begin
        sum := sum + n;
        n := n - 1
    end;
    write(sum)
end.
```

**四元式：**
```
0   =       5       -       n
1   =       0       -       sum
2   >       n       0       T0      # 循环条件
3   JZ      T0      -       9       # 条件为假，跳出循环
4   +       sum     n       T1      # sum + n
5   =       T1      -       sum     # sum := sum + n
6   -       n       1       T2      # n - 1
7   =       T2      -       n       # n := n - 1
8   JMP     -       -       2       # 跳回循环开始
9   WRITE   sum     -       -
10  END     -       -       -
```

### 示例 4: 过程调用

**源代码：**
```pl0
var x;

procedure inc;
begin
    x := x + 1
end;

begin
    x := 10;
    call inc;
    call inc;
    write(x)
end.
```

**符号表：**
```
名字    类型    层次    值      地址
x       变量    0       -       0
inc     过程    0       0       -
```

**四元式：**
```
0   PROC    inc     -       L0      # 过程入口
1   +       x       1       T0
2   =       T0      -       x
3   RET     -       -       -       # 过程返回
4   =       10      -       x
5   CALL    inc     -       -       # 调用过程
6   CALL    inc     -       -       # 再次调用
7   WRITE   x       -       -
8   END     -       -       -
```

## 🚀 使用方法

### 方法 1: Web 界面
```bash
streamlit run app.py
```

### 方法 2: 命令行
```python
from pl0_lexer import Lexer
from pl0_semantic import SemanticAnalyzer

code = """
var x, y;
begin
    x := 10;
    y := 20;
    write(x + y)
end.
"""

# 词法分析
lexer = Lexer(code)
tokens = lexer.get_tokens()

# 语义分析和四元式生成
analyzer = SemanticAnalyzer(tokens)
quadruples = analyzer.analyze()

# 打印结果
analyzer.symbol_table.print_table()
analyzer.print_quadruples()
```

### 方法 3: 运行测试
```bash
python test_semantic.py
```

## 📁 项目文件

```
.
├── pl0_lexer.py        # 词法分析器
├── pl0_parser.py       # 语法分析器 (SLR)
├── pl0_semantic.py     # 语义分析器 + 四元式生成器 ⭐
├── pl0_types.py        # 类型定义
├── app.py              # Streamlit Web 界面
├── test_semantic.py    # 测试用例（11个）
├── examples/           # 示例程序（10个）
└── readme.md           # 使用说明
```

## 🎓 技术亮点

1. **完整的符号表管理**
   - 支持多层嵌套作用域
   - 自动地址分配
   - 从内向外查找

2. **四元式中间代码**
   - 标准的四元式格式
   - 临时变量自动生成
   - 支持回填技术

3. **语义检查**
   - 声明检查
   - 类型检查
   - 作用域检查

4. **可视化界面**
   - 实时显示符号表
   - 实时显示四元式
   - 支持下载中间代码

## 📚 与传统编译器的对比

| 特性 | 本项目 | 传统 P-Code |
|------|--------|-------------|
| 中间代码形式 | 四元式 | 栈式指令 |
| 可读性 | 高 | 中 |
| 教学价值 | 高 | 中 |
| 执行方式 | 不执行 | 虚拟机执行 |
| 优化空间 | 大 | 小 |

## 🔮 扩展方向

1. **优化**
   - 常量折叠
   - 死代码消除
   - 公共子表达式消除

2. **三地址码转换**
   - 转换为三地址码
   - 生成汇编代码

3. **数据流分析**
   - 活跃变量分析
   - 到达定义分析

## 📝 总结

本项目成功实现了 PL/0 编译器的语义分析和四元式中间代码生成功能，包括：

- ✅ 完整的符号表管理系统
- ✅ 全面的语义检查机制
- ✅ 标准的四元式生成
- ✅ 11 个测试用例全部通过
- ✅ 可视化 Web 界面
- ✅ 详细的文档说明

**代码行数：** 约 800 行  
**测试覆盖：** 11 个测试用例  
**文档完整度：** 100%

---

**开发时间**: 2025-12-31  
**技术栈**: Python 3.8+, Streamlit  
**中间代码形式**: 四元式 (Quadruple)

