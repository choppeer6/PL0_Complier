# PL/0 四元式快速参考

## 四元式格式

```
(操作符, 参数1, 参数2, 结果)
```

## 操作符速查表

### 赋值
```
(=, 源操作数, -, 目标变量)
例: (=, 10, -, x)  表示 x := 10
```

### 算术运算
```
(+, 操作数1, 操作数2, 结果)
(-, 操作数1, 操作数2, 结果)
(*, 操作数1, 操作数2, 结果)
(/, 操作数1, 操作数2, 结果)
(NEG, 操作数, -, 结果)

例: (+, a, b, T0)  表示 T0 := a + b
    (NEG, x, -, T1) 表示 T1 := -x
```

### 关系运算
```
(<, 操作数1, 操作数2, 结果)
(>, 操作数1, 操作数2, 结果)
(=, 操作数1, 操作数2, 结果)
(#, 操作数1, 操作数2, 结果)  # 不等于
(<=, 操作数1, 操作数2, 结果)
(>=, 操作数1, 操作数2, 结果)

例: (<, x, y, T0)  表示 T0 := (x < y)
```

### 逻辑运算
```
(ODD, 操作数, -, 结果)

例: (ODD, x, -, T0)  表示 T0 := odd(x)
```

### 控制流
```
(JMP, -, -, 目标地址)     # 无条件跳转
(JZ, 条件, -, 目标地址)   # 条件为0时跳转

例: (JMP, -, -, 5)     跳转到第5条指令
    (JZ, T0, -, 10)    如果T0为0，跳转到第10条指令
```

### 过程
```
(PROC, 过程名, -, 标签)   # 过程入口
(CALL, 过程名, -, -)      # 调用过程
(RET, -, -, -)            # 过程返回

例: (PROC, inc, -, L0)
    (CALL, inc, -, -)
    (RET, -, -, -)
```

### 输入输出
```
(READ, -, -, 变量)        # 读取输入到变量
(WRITE, 表达式, -, -)     # 输出表达式的值

例: (READ, -, -, x)
    (WRITE, x, -, -)
```

### 其他
```
(END, -, -, -)            # 程序结束
```

## 常见模式

### 1. 简单赋值
```pl0
x := 10;
```
```
(=, 10, -, x)
```

### 2. 表达式赋值
```pl0
z := x + y;
```
```
(+, x, y, T0)
(=, T0, -, z)
```

### 3. 复杂表达式
```pl0
result := a * b + c;
```
```
(*, a, b, T0)
(+, T0, c, T1)
(=, T1, -, result)
```

### 4. if 语句
```pl0
if x > y then
    write(x)
```
```
(>, x, y, T0)
(JZ, T0, -, 3)
(WRITE, x, -, -)
```

### 5. while 循环
```pl0
while n > 0 do
    n := n - 1
```
```
0: (>, n, 0, T0)
1: (JZ, T0, -, 5)
2: (-, n, 1, T1)
3: (=, T1, -, n)
4: (JMP, -, -, 0)
```

### 6. 过程定义和调用
```pl0
procedure inc;
begin
    x := x + 1
end;

call inc;
```
```
0: (PROC, inc, -, L0)
1: (+, x, 1, T0)
2: (=, T0, -, x)
3: (RET, -, -, -)
4: (CALL, inc, -, -)
```

## 临时变量命名

- T0, T1, T2, ... - 用于存储中间计算结果
- 每个表达式计算都会生成新的临时变量

## 标签命名

- L0, L1, L2, ... - 用于过程入口标记
- 每个过程定义都会生成新的标签

## 地址回填

在生成跳转指令时，如果目标地址未知，先填 `?`，后续回填：

```
生成时: (JZ, T0, -, ?)
回填后: (JZ, T0, -, 10)
```

## 符号表结构

```
名字    类型    层次    值      地址
x       变量    0       -       0
max     常量    0       100     -
inc     过程    0       5       -
```

- **名字**: 标识符名称
- **类型**: 常量/变量/过程
- **层次**: 嵌套深度（0为最外层）
- **值**: 常量的值
- **地址**: 变量的地址或过程的入口地址

## 快速测试

```bash
# 运行所有测试
python test_semantic.py

# 启动 Web 界面
streamlit run app.py
```

## 常见错误

1. **未定义的标识符**
   ```
   语义错误: 未定义的标识符 'x'
   ```
   解决：先声明再使用

2. **重复定义**
   ```
   语义错误: 变量 'x' 在当前层次已定义
   ```
   解决：不要在同一层次重复声明

3. **类型错误**
   ```
   语义错误: 'max' 不是变量，不能赋值
   ```
   解决：常量不能被赋值

4. **语法错误**
   ```
   语义错误: 期望 ';'，但得到 'end'
   ```
   解决：检查语法，补充缺失的符号

